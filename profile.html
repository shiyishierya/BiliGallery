<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸ªäººä¸­å¿ƒ & åå°ç®¡ç†</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ä¿æŒåŸæ ·å¼ */
        body { background-color: #f4f5f7; }
        .profile-container { max-width: 1200px; margin: 30px auto; display: flex; gap: 20px; }
        .profile-container.visitor-mode .sidebar { display: none; }
        .profile-container.visitor-mode .content-area { width: 100%; }
        .sidebar { width: 250px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); height: fit-content; }
        .sidebar-header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .avatar-box { width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; overflow: hidden; border: 3px solid #f3f4f6; cursor: pointer; position: relative;}
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-box:hover::after { content: 'æ›´æ¢'; position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 12px; text-align: center; }
        .menu-btn { width: 100%; padding: 12px; text-align: left; background: none; border: none; border-radius: 8px; cursor: pointer; color: #555; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px;}
        .menu-btn:hover { background: #f9fafb; }
        .menu-btn.active { background: #e0e7ff; color: #4f46e5; font-weight: bold; }
        .content-area { flex: 1; background: white; border-radius: 12px; padding: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); min-height: 600px; }
        .tab-panel { display: none; animation: fadeIn 0.3s ease; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ğŸ”¥ ä¼˜åŒ–åçš„ä¸Šä¼ é¡µæ ·å¼ */
        .upload-title { font-size: 20px; font-weight: bold; margin-bottom: 25px; color: #333; border-left: 4px solid #00aeec; padding-left: 12px; }
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; margin-bottom: 30px; background: #f8fafc; }
        .upload-zone:hover { border-color: #00aeec; background: #f0f9ff; }
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 20px; }
        .preview-item { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
        
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: #555; }
        .input-group input, .input-group textarea, .input-group select { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; transition: 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus { border-color: #00aeec; outline: none; box-shadow: 0 0 0 3px rgba(0,174,236,0.1); }
        .btn-primary { background: #00aeec; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { background: #009cd6; transform: translateY(-2px); }

        /* å…¶ä»–æ ·å¼ä¿æŒ */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .thumb-img { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
        .action-btn { padding: 4px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; margin-right: 4px; border: none; color: white; display: inline-block; }
        .btn-edit { background-color: #3b82f6; } .btn-ghost { background-color: #8b5cf6; } .btn-manage-cmt { background-color: #f59e0b; } .btn-delete { background-color: #ef4444; }
        .visitor-header { display: flex; align-items: center; gap: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 20px; }
        .v-avatar { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); object-fit: cover; }
        .v-info h2 { margin: 0 0 5px 0; color: #333; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .img-card { cursor: pointer; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 450px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; cursor: pointer; color: #999; font-size: 20px; }
        
        /* è®¾ç½®é¡µé¢å¡ç‰‡ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .setting-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; }
        .setting-card h3 { margin: 0 0 20px 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; font-size: 16px; }
        .security-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 14px; }
        .btn-text { color: #00aeec; cursor: pointer; border: none; background: none; }
        .verify-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .verify-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .verify-btn { padding: 0 15px; border: 1px solid #00aeec; background: white; color: #00aeec; border-radius: 6px; cursor: pointer; }
        .admin-cmt-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .admin-cmt-item { background: #f9fafb; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; border: 1px solid #eee; }
        .cmt-del-btn { color: #ef4444; background: none; border: 1px solid #ef4444; border-radius: 4px; padding: 2px 6px; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="gallery.html" style="font-weight:bold; color:#4f46e5; text-decoration:none;">â† è¿”å›å›¾åº“é¦–é¡µ</a>
        <button id="logoutBtn" class="btn-primary" style="width: auto; background-color: #ef4444;">é€€å‡ºç™»å½•</button>
    </nav>

    <div class="profile-container" id="profileContainer">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar-box" onclick="document.getElementById('avatarInput').click()">
                    <img id="userAvatar" src="assets/default.png" onerror="this.src='https://via.placeholder.com/150'">
                </div>
                <h3 id="userName">åŠ è½½ä¸­...</h3>
                <input type="file" id="avatarInput" hidden accept="image/*">
            </div>
            <nav>
                <button class="menu-btn active" onclick="switchTab('upload')">ğŸ“¤ å‘å¸ƒä½œå“</button>
                <button class="menu-btn" onclick="switchTab('admin')">ğŸ›¡ï¸ å†…å®¹ç®¡ç†</button>
                <button class="menu-btn" onclick="switchTab('fav')">â¤ æˆ‘çš„æ”¶è—</button>
                <button class="menu-btn" onclick="switchTab('history')">ğŸ•’ å†å²è¶³è¿¹</button>
                <button class="menu-btn" onclick="switchTab('settings')">âš™ï¸ è´¦å·è®¾ç½®</button>
            </nav>
        </div>

        <div class="content-area">
            <div id="visitorHeader" class="visitor-header" style="display:none;">
                <img id="vAvatar" class="v-avatar" src="">
                <div class="v-info"><h2 id="vName">ç”¨æˆ·æ˜µç§°</h2><p id="vDesc">è¿™ä½ç”¨æˆ·å¾ˆç¥ç§˜ï¼Œè¿˜æ²¡æœ‰å†™ç®€ä»‹ã€‚</p></div>
            </div>
            <div id="visitorWorks" class="tab-panel"><h3>Ta çš„å‘å¸ƒ</h3><div class="gallery-grid" id="visitorGrid"></div></div>

            <div id="upload" class="tab-panel active">
                <div class="upload-title">1. ä¸Šä¼ å›¾ç‰‡</div>
                <div class="input-group">
                    <div class="upload-zone" id="dropZone">
                        <p id="uploadText" style="color:#666; margin-bottom:5px;">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
                        <p style="font-size:12px; color:#999;">æ”¯æŒ JPG/PNGï¼Œå¯æ‰¹é‡ä¸Šä¼ </p>
                        <p id="compressTip" style="display:none; color:#00aeec; font-weight:bold;">ğŸ“¸ æ­£åœ¨å¤„ç†...</p>
                        <div class="preview-grid" id="previewGrid"></div>
                        <input type="file" id="fileInput" hidden accept="image/*" multiple>
                    </div>
                </div>

                <div class="upload-title">2. ä½œå“ä¿¡æ¯</div>
                <div class="form-row">
                    <div class="input-group">
                        <label>ä½œå“æ ‡é¢˜</label>
                        <input type="text" id="imgTitle" placeholder="ç»™ä½œå“èµ·ä¸ªåå­—">
                    </div>
                    <div class="input-group">
                        <label>é€‰æ‹©åˆ†ç±»</label>
                        <select id="imgType">
                            <option value="nature">ğŸ”ï¸ è‡ªç„¶é£å…‰</option>
                            <option value="city">ğŸ™ï¸ åŸå¸‚å»ºç­‘</option>
                            <option value="tech">ğŸ’» æœªæ¥ç§‘æŠ€</option>
                            <option value="art">ğŸ¨ è‰ºæœ¯åˆ›æ„</option>
                            <option value="fruit">ğŸ“ æ°´æœç¾é£Ÿ</option>
                            <option value="comic">ğŸ”® åŠ¨æ¼«æ¼«ç”»</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>ä½œå“ä»‹ç» / åˆ›ä½œå¿ƒå¾—</label>
                    <textarea id="imgDesc" rows="4" placeholder="å†™ç‚¹ä»€ä¹ˆï¼Œè®©å¤§å®¶æ›´äº†è§£è¿™å¹…ä½œå“..."></textarea>
                </div>
                
                <button id="doUploadBtn" class="btn-primary" style="margin-top:10px;">ç«‹å³å‘å¸ƒ</button>
            </div>

            <div id="admin" class="tab-panel">
                <div style="display:flex; justify-content:space-between; align-items:center;"><h2>å†…å®¹ç®¡ç†åå°</h2><span style="font-size:12px; color:#666;">ç®¡ç†å‘˜æƒé™å·²æ¿€æ´»</span></div>
                <div style="overflow-x: auto;"><table class="admin-table"><thead><tr><th>å°é¢</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>çƒ­åº¦</th><th style="width:250px;">GM æ“ä½œ</th></tr></thead><tbody id="adminTableBody"></tbody></table></div>
            </div>

            <div id="fav" class="tab-panel"><h2>æˆ‘çš„æ”¶è—</h2><div class="gallery-grid" id="favGrid"></div></div>
            <div id="history" class="tab-panel"><h2>å†å²è¶³è¿¹</h2><div class="gallery-grid" id="historyGrid"></div></div>
            
            <div id="settings" class="tab-panel">
                <h2 style="margin-bottom:25px;">è´¦å·è®¾ç½®</h2>
                <div class="settings-grid">
                    <div class="setting-card">
                        <h3>å…¬å¼€èµ„æ–™</h3>
                        <div class="input-group"><label>æ˜µç§°</label><input type="text" id="nicknameInput" placeholder="è®¾ç½®ä¸€ä¸ªå¥½å¬çš„åå­—"></div>
                        <button id="saveProfileBtn" class="btn-primary" style="margin-top:10px;">æ›´æ–°èµ„æ–™</button>
                    </div>
                    <div class="setting-card">
                        <h3>è´¦å·å®‰å…¨</h3>
                        <div class="security-item"><div><span class="security-label">æ‰‹æœºå·ï¼š</span><span class="security-val" id="dispPhone">æœªç»‘å®š</span></div><button class="btn-text" onclick="openVerifyModal('phone')">æ›´æ¢</button></div>
                        <div class="security-item"><div><span class="security-label">é‚®ç®±ï¼š</span><span class="security-val" id="dispEmail">æœªç»‘å®š</span></div><button class="btn-text" onclick="openVerifyModal('email')">æ›´æ¢</button></div>
                        <div class="security-item"><div><span class="security-label">ç™»å½•å¯†ç </span></div><button class="btn-text" onclick="openVerifyModal('password')">ä¿®æ”¹</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="verifyModal"><div class="modal-box"><span class="close-modal" onclick="closeModal('verifyModal')">Ã—</span><h3 id="verifyTitle">å®‰å…¨éªŒè¯</h3><div class="input-group" id="targetInputGroup"><label id="targetLabel">æ–°æ‰‹æœºå·</label><input type="text" id="targetInput"></div><div id="passChangeGroup" style="display:none;"><div class="input-group"><label>æ—§å¯†ç </label><input type="password" id="oldPass"></div><div class="input-group"><label>æ–°å¯†ç </label><input type="password" id="newPass"></div></div><div class="input-group" id="codeGroup"><label>éªŒè¯ç </label><div class="verify-group"><input type="text" class="verify-input" id="verifyCodeInput" placeholder="è¾“å…¥çŸ­ä¿¡éªŒè¯ç "><button class="verify-btn" id="getCodeBtn" onclick="sendMockCode()">è·å–éªŒè¯ç </button></div></div><button class="btn-primary" onclick="confirmUpdate()">ç¡®è®¤ä¿®æ”¹</button></div></div>
    <div class="modal-overlay" id="editModal"><div class="modal-box"><h3>ä¿®æ”¹å›¾ç‰‡</h3><input type="hidden" id="editId"><div class="input-group"><label>æ ‡é¢˜</label><input type="text" id="editTitle"></div><div class="input-group"><label>åˆ†ç±»</label><select id="editType"><option value="nature">è‡ªç„¶é£å…‰</option><option value="city">åŸå¸‚å»ºç­‘</option><option value="tech">æœªæ¥ç§‘æŠ€</option><option value="art">è‰ºæœ¯åˆ›æ„</option><option value="fruit">æ°´æœç¾é£Ÿ</option><option value="comic">åŠ¨æ¼«æ¼«ç”»</option></select></div><div style="display:flex;gap:10px;margin-top:15px;"><button class="btn-primary" onclick="saveEdit()">ä¿å­˜</button><button class="btn-primary" style="background:#ccc;color:#333" onclick="closeModal('editModal')">å–æ¶ˆ</button></div></div></div>
    <div class="modal-overlay" id="ghostModal"><div class="modal-box"><h3>ğŸ‘» GM é©¬ç”²</h3><input type="hidden" id="ghostSrc"><div class="input-group"><label>æ˜µç§°</label><input type="text" id="ghostName"></div><div class="input-group"><label>IP</label><input type="text" id="ghostIP"></div><div class="input-group"><label>è¯„è®º</label><textarea id="ghostText"></textarea></div><div style="display:flex;gap:10px;margin-top:15px;"><button class="btn-primary" style="background:#ccc;color:#333" onclick="closeModal('ghostModal')">å–æ¶ˆ</button><button class="btn-primary" style="background:#8b5cf6;" onclick="sendGhostComment()">å‘é€</button></div></div></div>
    <div class="modal-overlay" id="cmtManageModal"><div class="modal-box" style="width:500px;"><h3>è¯„è®ºç®¡ç†</h3><input type="hidden" id="cmtManageSrc"><div id="adminCmtList" class="admin-cmt-list"></div><div style="margin-top:20px;text-align:right;"><button class="btn-primary" style="background:#ccc;color:#333" onclick="closeModal('cmtManageModal')">å…³é—­</button></div></div></div>

    <script type="module">
        import { getCurrentUser, updateCurrentUser, uploadNewImage, getImages, deleteImage, updateImage, addComment, getComments, deleteComment, getImageById, changePassword, getImagesByUploader, findUserByNickname, validatePhone, validateEmail } from './js/modules/utils.js';
        import './js/modules/music.js';

        const currentUser = getCurrentUser();
        const params = new URLSearchParams(window.location.search);
        const visitorTarget = params.get('visitor');

        if (visitorTarget && (!currentUser || currentUser.nickname !== visitorTarget)) { initVisitorMode(visitorTarget); } 
        else { initOwnerMode(); }

        // ... (ä¿æŒ initVisitorMode, initOwnerMode, renderUser, å¼¹çª—å‡½æ•° ç­‰é€»è¾‘ä¸å˜) ...
        // ... (ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„è¿™äº›å‡½æ•°ï¼Œè¯·åŠ¡å¿…ä¿ç•™ï¼) ...
        
        async function initVisitorMode(nickname) {
            document.getElementById('profileContainer').classList.add('visitor-mode');
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('visitorWorks').classList.add('active');
            document.getElementById('visitorHeader').style.display = 'flex';
            const targetUser = findUserByNickname(nickname);
            document.getElementById('vName').innerText = targetUser.nickname;
            document.getElementById('vAvatar').src = targetUser.avatar;
            if(targetUser.bio) document.getElementById('vDesc').innerText = targetUser.bio;
            const works = await getImagesByUploader(nickname);
            const grid = document.getElementById('visitorGrid');
            grid.innerHTML = works.length ? works.map(img => `<div class="img-card" onclick="location.href='gallery.html'"><img src="${img.src}" style="height:180px;width:100%;object-fit:cover;border-radius:8px;"><div style="font-size:14px;margin-top:5px;">${img.title}</div></div>`).join('') : '<p style="text-align:center;color:#999;padding:50px">æš‚æ— å‘å¸ƒ</p>';
        }

        function initOwnerMode() {
            if(!currentUser) return location.href = 'index.html';
            renderUser();
            window.switchTab = function(tabId) {
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                event.currentTarget.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                if(tabId === 'fav') renderGrid('favGrid', currentUser.favorites);
                if(tabId === 'history') renderGrid('historyGrid', currentUser.history);
                if(tabId === 'admin') renderAdminTable();
            };
        }

        function renderUser() {
            document.getElementById('userName').innerText = currentUser.nickname || currentUser.phone;
            document.getElementById('nicknameInput').value = currentUser.nickname || '';
            document.getElementById('dispPhone').innerText = currentUser.phone || 'æœªç»‘å®š';
            document.getElementById('dispEmail').innerText = currentUser.email || 'æœªç»‘å®š';
            if(currentUser.avatar) document.getElementById('userAvatar').src = currentUser.avatar;
        }

        // ğŸ”¥ ä¿®å¤çš„å¤šå›¾ä¸Šä¼ é€»è¾‘
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        let uploadedImages = []; 

        dropZone.addEventListener('click', () => fileInput.click());

        function compressImage(file, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0); resolve(canvas.toDataURL('image/jpeg', quality));
                    }
                }
            });
        }

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;
            uploadedImages = [];
            document.getElementById('compressTip').style.display = 'block';
            document.getElementById('uploadText').style.display = 'none';
            document.getElementById('previewGrid').innerHTML = ''; 

            try {
                for (let file of files) {
                    const base64 = await compressImage(file);
                    uploadedImages.push(base64);
                    // æ·»åŠ é¢„è§ˆ
                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'preview-item';
                    document.getElementById('previewGrid').appendChild(img);
                }
                document.getElementById('compressTip').style.display = 'none';
            } catch (err) { alert('å¤„ç†å¤±è´¥'); }
        });

        document.getElementById('doUploadBtn').addEventListener('click', async () => {
            const title = document.getElementById('imgTitle').value.trim();
            const desc = document.getElementById('imgDesc').value.trim(); // ğŸ”¥ è·å–ä»‹ç»
            const type = document.getElementById('imgType').value;
            if(uploadedImages.length === 0 || !title) return alert('è¯·é€‰æ‹©å›¾ç‰‡å¹¶å¡«å†™æ ‡é¢˜');
            
            const res = await uploadNewImage({images: uploadedImages, title, type, desc});
            if(res.success) { alert('å‘å¸ƒæˆåŠŸ'); location.href='gallery.html'; } else { alert('å‘å¸ƒå¤±è´¥'); }
        });

        // ... (ä¿æŒåŸæœ‰çš„ GMåå°, renderGrid, å¼¹çª—ç­‰é€»è¾‘) ...
        async function renderGrid(containerId, idList) { const container = document.getElementById(containerId); if(!idList || idList.length === 0) return container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">æš‚æ— è®°å½•</p>'; const cards = await Promise.all(idList.map(async id => { const img = await getImageById(id); if (!img) return ''; return `<div class="img-card" onclick="location.href='gallery.html'"><img src="${img.src}" style="height:150px;width:100%;object-fit:cover;border-radius:8px;"><div style="font-size:12px;margin-top:5px;">${img.title}</div></div>`; })); container.innerHTML = cards.join(''); }
        async function renderAdminTable() { const list = await getImages('all'); const tbody = document.getElementById('adminTableBody'); tbody.innerHTML = list.map(img => `<tr><td><img src="${img.src}" class="thumb-img"></td><td><div style="font-weight:bold;">${img.title}</div></td><td>${img.type}</td><td>${img.views}</td><td><button class="action-btn btn-edit" onclick="openEdit(${img.id}, '${img.title}', '${img.type}')">æ”¹</button><button class="action-btn btn-ghost" onclick="openGhostComment(${img.id})">åˆ·</button><button class="action-btn btn-manage-cmt" onclick="openCmtManage(${img.id})">ç®¡</button><button class="action-btn btn-delete" onclick="doDelete(${img.id})">åˆ </button></td></tr>`).join(''); }
        
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.doDelete = (id) => { if(confirm('åˆ ï¼Ÿ')) deleteImage(id).then(() => renderAdminTable()); };
        window.openEdit = (id, title, type) => { document.getElementById('editId').value = id; document.getElementById('editTitle').value = title; document.getElementById('editType').value = type; document.getElementById('editModal').style.display = 'flex'; };
        window.saveEdit = async () => { await updateImage(parseInt(document.getElementById('editId').value), document.getElementById('editTitle').value, document.getElementById('editType').value); alert('æˆåŠŸ'); closeModal('editModal'); renderAdminTable(); };
        window.openGhostComment = (id) => { document.getElementById('ghostSrc').value = id; document.getElementById('ghostModal').style.display = 'flex'; };
        window.sendGhostComment = () => { addComment(parseInt(document.getElementById('ghostSrc').value), document.getElementById('ghostText').value, {nickname: document.getElementById('ghostName').value, ip: document.getElementById('ghostIP').value}); alert('å·²å‘é€'); closeModal('ghostModal'); };
        window.openCmtManage = (id) => { document.getElementById('cmtManageSrc').value = id; renderCmtManageList(id); document.getElementById('cmtManageModal').style.display = 'flex'; };
        window.renderCmtManageList = (id) => { const list = getComments(id); document.getElementById('adminCmtList').innerHTML = list.map((c, i) => `<div class="admin-cmt-item"><span>${c.nickname}: ${c.text}</span><button class="cmt-del-btn" onclick="doDeleteComment(${id},${i})">Ã—</button></div>`).join(''); };
        window.doDeleteComment = (id, index) => { deleteComment(id, index); renderCmtManageList(id); };

        let currentVerifyType = '', mockVerifyCode = '';
        window.openVerifyModal = (type) => { currentVerifyType = type; document.getElementById('verifyModal').style.display = 'flex'; document.getElementById('targetInputGroup').style.display = type === 'password' ? 'none' : 'block'; document.getElementById('passChangeGroup').style.display = type === 'password' ? 'block' : 'none'; document.getElementById('codeGroup').style.display = type === 'password' ? 'none' : 'block'; document.getElementById('verifyTitle').innerText = type === 'phone' ? 'æ›´æ¢æ‰‹æœº' : (type === 'email' ? 'æ›´æ¢é‚®ç®±' : 'ä¿®æ”¹å¯†ç '); };
        window.sendMockCode = () => { mockVerifyCode = '123456'; alert('éªŒè¯ç ï¼š123456'); };
        window.confirmUpdate = () => {
            if(currentVerifyType === 'password') { const res = changePassword(document.getElementById('oldPass').value, document.getElementById('newPass').value); alert(res.msg); if(res.success) closeModal('verifyModal'); } 
            else { if(document.getElementById('verifyCodeInput').value !== mockVerifyCode) return alert('éªŒè¯ç é”™'); if(currentVerifyType === 'phone') currentUser.phone = document.getElementById('targetInput').value; if(currentVerifyType === 'email') currentUser.email = document.getElementById('targetInput').value; updateCurrentUser(currentUser); renderUser(); alert('ä¿®æ”¹æˆåŠŸ'); closeModal('verifyModal'); }
        };
        document.getElementById('saveProfileBtn').addEventListener('click', () => { currentUser.nickname = document.getElementById('nicknameInput').value; updateCurrentUser(currentUser); renderUser(); alert('ä¿å­˜æˆåŠŸ'); });
        document.getElementById('avatarInput').addEventListener('change', async (e) => { if(e.target.files[0]) { currentUser.avatar = await compressImage(e.target.files[0], 0.6); updateCurrentUser(currentUser); renderUser(); } });
        document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.removeItem('gallery_current_user'); location.href = 'index.html'; });
    </script>
</body>
</html>